# Render Blueprint - Server Guard Deployment
# https://render.com/docs/blueprint-spec
#
# UNIFIED SINGLE-CONTAINER DEPLOYMENT
# ====================================
# This configuration runs all backend services in a single container.
# Services communicate via localhost, solving connectivity issues on free tier.
# The container runs: API Gateway, Ingest, Detection, Alert, Response, and Model services.

services:
  # ============================================
  # FRONTEND - React Static Site (Free)
  # ============================================
  - type: web
    name: server-guard-frontend
    runtime: static
    rootDir: frontend
    buildCommand: npm install && npm run build
    staticPublishPath: dist
    envVars:
      - key: VITE_API_URL
        value: https://server-guard-backend.onrender.com
    routes:
      - type: rewrite
        source: /api/*
        destination: https://server-guard-backend.onrender.com/api/*
      - type: rewrite
        source: /socket.io/*
        destination: https://server-guard-backend.onrender.com/socket.io/*
    headers:
      - path: /*
        name: X-Frame-Options
        value: DENY
      - path: /*
        name: X-Content-Type-Options
        value: nosniff

  # ============================================
  # UNIFIED BACKEND - All Services in One Container
  # ============================================
  # This single container runs all backend microservices:
  # - API Gateway (main entry point, handles external requests)
  # - Ingest Service (telemetry ingestion)
  # - Detection Engine (rule-based + ML anomaly detection)
  # - Alert Manager (alert generation and routing)
  # - Response Engine (automated incident response / SOAR)
  # - Model Service (ML models for threat detection)
  #
  # All services communicate via localhost, eliminating
  # inter-service connectivity issues on Render free tier.
  # ============================================
  - type: web
    name: server-guard-backend
    runtime: docker
    plan: free
    dockerfilePath: ./Dockerfile.unified
    dockerContext: .
    envVars:
      - key: PYTHON_VERSION
        value: "3.11"
      - key: DEMO_MODE
        value: "true"
      # Internal localhost URLs (set in Dockerfile, but can be overridden)
      - key: INGEST_SERVICE_URL
        value: http://127.0.0.1:8001
      - key: DETECTION_ENGINE_URL
        value: http://127.0.0.1:8002
      - key: ALERT_MANAGER_URL
        value: http://127.0.0.1:8003
      - key: RESPONSE_ENGINE_URL
        value: http://127.0.0.1:8004
      - key: MODEL_SERVICE_URL
        value: http://127.0.0.1:8006
      - key: API_GATEWAY_URL
        value: http://127.0.0.1:3001
    healthCheckPath: /health
